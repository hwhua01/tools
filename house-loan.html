<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æˆ¿å±‹è³¼è²·èˆ‡æˆ¿è²¸è¨ˆç®—æ©Ÿ</title>
    <style>
        :root {
            --primary-color:#F9A826; 
            --primary-hover:#E6951F; 
            --accent-bg:#C9E3FF;
            --text-color:#2c3e50; 
            --light-bg:#F4F7FB; 
            --negative-color:#e74c3c;
            --positive-color:#27ae60;
            --border-color:#bdc3c7;
            --disabled-bg: #f5f7fa;
            --disabled-border: #d0d6dc;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family:'Segoe UI',Tahoma,Helvetica,Arial,sans-serif;
            background: #F4F7FB;
            min-height:100vh;
            padding:20px;
            display:flex;
            justify-content:center;
            align-items:flex-start;
        }
        .calculator-container {
            max-width:680px;
            width:100%;
            background:#fff;
            padding:40px;
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
            animation:fadeIn .5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity:0; transform:translateY(-30px) scale(0.95); }
            to { opacity:1; transform:translateY(0) scale(1); }
        }
        h2 {
            text-align:center;
            color:var(--text-color);
            margin-bottom:10px;
            font-size:2em;
        }
        .subtitle {
            text-align:center;
            color:#7f8c8d;
            font-size:0.9em;
            margin-bottom:25px;
            padding-bottom:20px;
            border-bottom:2px solid #e0e0e0;
        }
        .subtitle a {
            color:var(--primary-color);
            text-decoration:none;
            font-weight:700;
            transition:color 0.3s;
        }
        .subtitle a:hover {
            color:#7f8c8d;
        }
        .section-header {
            font-size:1.1em;
            font-weight:700;
            color:var(--text-color);
            margin:25px 0 15px 0;
            padding-left:10px;
            border-left:4px solid var(--primary-color);
        }
        .input-group {
            margin-bottom:18px;
        }
        .input-group label {
            display:block;
            margin-bottom:8px;
            font-weight:600;
            color:var(--text-color);
            font-size:0.95em;
        }
        /* æ³¨æ„ï¼šé€™è£¡æŠŠ input[type="text"] èˆ‡ input[type="number"] ä¸€èµ·å¥—ç”¨ç›¸åŒæ¨£å¼ï¼Œç¢ºä¿ UI èˆ‡åŸæœ¬å®Œå…¨ä¸€è‡´ */
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width:100%;
            padding:12px 16px;
            border:2px solid var(--border-color);
            border-radius:10px;
            font-size:1em;
            background:#fafafa;
            transition:all .3s;
        }
        .input-group input[type="number"]:focus,
        .input-group input[type="text"]:focus, 
        .input-group select:focus {
            border-color:var(--primary-color);
            outline:none;
            box-shadow:0 0 0 3px rgba(249,168,38,0.1);
            background:#fff;
        }
        .hint {
            color:#95a5a6;
            font-size:0.85em;
            margin-top:6px;
            display:block;
        }
        
        /* åˆ†æ®µåˆ©ç‡æ¨£å¼ */
        .rate-container {
            background:#f8f9fa;
            padding:20px;
            border-radius:12px;
            margin-bottom:20px;
        }
        .rate-row {
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:15px;
            flex-wrap:wrap;
            padding:12px;
            background:#fff;
            border-radius:8px;
            border:2px solid #e0e0e0;
            transition:all 0.3s;
        }
        .rate-row:hover {
            border-color:var(--primary-color);
            box-shadow:0 2px 8px rgba(249,168,38,0.1);
        }
        .rate-row label {
            min-width:95px;
            font-weight:600;
            color:var(--text-color);
            font-size:0.95em;
        }
        .rate-row input {
            width:85px;
            padding:8px 10px;
            border:2px solid var(--border-color);
            border-radius:8px;
            font-size:0.95em;
            text-align:center;
            background:#fafafa;
            transition:all .3s;
        }
        .rate-row input:focus {
            border-color:var(--primary-color);
            outline:none;
            box-shadow:0 0 0 3px rgba(249,168,38,0.1);
            background:#fff;
        }
        .rate-row span {
            color:#7f8c8d;
            font-size:0.95em;
            font-weight:500;
        }

        /* disabled / åç™½ æ¨£å¼ */
        .disabled-stage {
            background: var(--disabled-bg);
            border-color: var(--disabled-border) !important;
            opacity: 0.95;
        }
        .disabled-stage input {
            background: var(--disabled-bg) !important;
            border-color: var(--disabled-border) !important;
            color: #7d8690;
            pointer-events: none;
        }
        
        .btn-primary {
            width:100%;
            padding:15px 20px;
            background:linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color:#fff;
            border:none;
            border-radius:12px;
            font-size:1.1em;
            font-weight:700;
            cursor:pointer;
            box-shadow:0 6px 20px rgba(249,168,38,0.3);
            transition:all .3s;
            margin-top:10px;
        }
        .btn-primary:hover {
            transform:translateY(-3px);
            box-shadow:0 8px 25px rgba(249,168,38,0.4);
        }
        .btn-primary:active {
            transform:translateY(-1px);
        }
        .btn-secondary {
            width:100%;
            padding:12px 20px;
            background:#95a5a6;
            color:#fff;
            border:none;
            border-radius:12px;
            font-size:1em;
            font-weight:600;
            cursor:pointer;
            margin-top:10px;
            transition:all .3s;
        }
        .btn-secondary:hover {
            background:#7f8c8d;
            transform:translateY(-2px);
        }
        
        .result-area {
            margin-top:30px;
            padding:25px;
            border-radius:16px;
            background:linear-gradient(135deg, var(--accent-bg) 0%, #a8d5ff 100%);
            border:3px solid #a3c9f2;
            display:none;
            animation:slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity:0; transform:translateY(30px); }
            to { opacity:1; transform:translateY(0); }
        }
        .result-area h3 {
            text-align:center;
            color:var(--text-color);
            margin-bottom:20px;
            font-size:1.4em;
        }
        .result-item {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:12px 15px;
            margin:12px 0;
            background:rgba(255,255,255,0.85);
            border-radius:10px;
            color:var(--text-color);
            transition:all 0.3s;
        }
        .result-item:hover {
            background:rgba(255,255,255,0.95);
            transform:translateX(5px);
        }
        .result-item.highlight {
            border:2px solid var(--primary-color);
            font-weight:700;
            background:rgba(255,255,255,0.95);
        }
        .result-label {
            font-weight:500;
        }
        .result-value {
            font-weight:700;
            font-size:1.05em;
        }
        .result-value.positive {
            color:var(--positive-color);
        }
        .result-value.negative {
            color:var(--negative-color);
        }
        .info-box {
            background:#e8f4f8;
            border-left:4px solid #3498db;
            padding:15px;
            border-radius:8px;
            margin-top:15px;
            color:#2c3e50;
            line-height:1.8;
        }
        .info-box strong {
            color:#2980b9;
        }
        
        /* Modal */
        .modal-backdrop {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:9999;
            backdrop-filter:blur(5px);
        }
        .modal-backdrop.show {
            display:flex;
        }
        .modal-dialog {
            background:#fff;
            padding:25px;
            border-radius:16px;
            width:92%;
            max-width:500px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
            animation:modalPop 0.3s ease-out;
        }
        @keyframes modalPop {
            from { opacity:0; transform:scale(0.8); }
            to { opacity:1; transform:scale(1); }
        }
        .modal-dialog h4 {
            color:var(--negative-color);
            margin-bottom:15px;
            font-size:1.3em;
        }
        .modal-dialog ul {
            margin:15px 0;
            padding-left:20px;
        }
        .modal-dialog li {
            margin:8px 0;
            color:var(--text-color);
        }
        .modal-actions {
            margin-top:20px;
            text-align:right;
        }
        .btn-ok {
            background:var(--primary-color);
            color:#fff;
            border:none;
            padding:10px 24px;
            border-radius:8px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }
        .btn-ok:hover {
            background:var(--primary-hover);
            transform:translateY(-2px);
        }
        
        @media (max-width:600px) {
            .calculator-container {
                padding:25px 20px;
            }
            h2 {
                font-size:1.6em;
            }
            .rate-row {
                flex-direction:column;
                align-items:flex-start;
            }
            .rate-row label {
                min-width:auto;
            }
            .result-item {
                flex-direction:column;
                align-items:flex-start;
                gap:5px;
            }
        }
    </style>
</head>
<body>
<div class="calculator-container">
    <h2>ğŸ¡ æˆ¿å±‹è³¼è²·èˆ‡æˆ¿è²¸è¨ˆç®—æ©Ÿ</h2>
    <div class="subtitle">
        ç²¾æº–è¨ˆç®—æˆ¿è²¸æˆæœ¬ï¼Œè¼•é¬†è¦åŠƒè³¼å±‹é ç®—<br>
        <a href="https://leveragetw.com/" target="_blank">æ§“æ¡¿å­¸é™¢</a>
    </div>

    <div class="section-header">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
    
    <div class="input-group">
        <label for="purchasePrice">ğŸ  æˆ¿å±‹ç¸½åƒ¹ (è¬å…ƒ)</label>
        <!-- ä¿æŒåŸæœ¬ä½ç½®èˆ‡å¤§å°ï¼Œtype æ”¹ç‚º text ä»¥æ–¹ä¾¿é¡¯ç¤ºåƒåˆ†ç¬¦ï¼›æ¨£å¼èˆ‡åŸæœ¬ç›¸åŒ -->
        <input type="text" id="purchasePrice" value="1000" aria-label="æˆ¿å±‹ç¸½åƒ¹">
        <small class="hint">ä¾‹å¦‚ï¼šä¸€åƒè¬è«‹è¼¸å…¥ 1000ï¼ˆåƒä½ç¬¦æœƒè‡ªå‹•é¡¯ç¤ºï¼‰</small>
    </div>

    <div class="input-group">
        <label for="downPayment">ğŸ’° è‡ªå‚™æ¬¾ / é ­æœŸæ¬¾ (è¬å…ƒ)</label>
        <input type="text" id="downPayment" value="200" aria-label="è‡ªå‚™æ¬¾">
    </div>

    <div class="input-group">
        <label for="loanTerm">â° è²¸æ¬¾ç¸½å¹´æœŸ (å¹´)</label>
        <input type="number" id="loanTerm" value="30" min="1" step="1">
    </div>

    <div class="input-group">
        <label for="gracePeriod">ğŸ•Šï¸ å¯¬é™æœŸ (å¹´)</label>
        <select id="gracePeriod">
            <option value="0" selected>0 å¹´ï¼ˆç„¡å¯¬é™æœŸï¼‰</option>
            <option value="1">1 å¹´</option>
            <option value="2">2 å¹´</option>
            <option value="3">3 å¹´</option>
            <option value="4">4 å¹´</option>
            <option value="5">5 å¹´</option>
        </select>
        <small class="hint">å¯¬é™æœŸå…§åªç¹³åˆ©æ¯ï¼Œåˆ©ç‡æ¡ç”¨ç¬¬ä¸€éšæ®µå¹´åˆ©ç‡</small>
    </div>

    <div class="section-header">ğŸ“Š åˆ†æ®µå¼åˆ©ç‡è¨­å®š</div>
    
    <div class="rate-container">
        <div id="rateRow1" class="rate-row">
            <label>ç¬¬ä¸€æ®µåˆ©ç‡</label>
            <input type="number" id="stage1Start" placeholder="" step="1" min="1">
            <span>~</span>
            <input type="number" id="stage1End" placeholder="" step="1" min="1">
            <span>æœˆ</span>
            <input type="number" id="stage1Rate" placeholder="" step="0.01" min="0">
            <span>%</span>
        </div>

        <div id="rateRow2" class="rate-row">
            <label>ç¬¬äºŒæ®µåˆ©ç‡</label>
            <input type="number" id="stage2Start" placeholder="" step="1" min="1">
            <span>~</span>
            <input type="number" id="stage2End" placeholder="" step="1" min="1">
            <span>æœˆ</span>
            <input type="number" id="stage2Rate" placeholder="" step="0.01" min="0">
            <span>%</span>
        </div>

        <div id="rateRow3" class="rate-row">
            <label>ç¬¬ä¸‰æ®µåˆ©ç‡</label>
            <input type="number" id="stage3Start" placeholder="" step="1" min="1">
            <span>~</span>
            <input type="number" id="stage3End" placeholder="" step="1" min="1">
            <span>æœˆ</span>
            <input type="number" id="stage3Rate" placeholder="" step="0.01" min="0">
            <span>%</span>
        </div>
    </div>
    
    <small class="hint" style="margin-top:-10px; display:block;">
        ğŸ’¡ <strong>å¡«å¯«æç¤ºï¼š</strong><br>
        â€¢ è‹¥ç„¡å¯¬é™æœŸï¼šç¬¬ä¸€æ®µå¾ç¬¬ 1 æœˆé–‹å§‹<br>
        â€¢ è‹¥æœ‰å¯¬é™æœŸï¼ˆå¦‚ 2 å¹´ = 24 å€‹æœˆï¼‰ï¼šç¬¬ä¸€æ®µæ‡‰å¾ç¬¬ 25 æœˆé–‹å§‹ï¼ˆç³»çµ±æœƒè‡ªå‹•å¡«å…¥ï¼‰<br>
        â€¢ å„æ®µæœŸæ•¸å¿…é ˆé€£çºŒä¸”è¦†è“‹åˆ°è²¸æ¬¾çµæŸ<br>
        â€¢ è‹¥åªæœ‰å–®ä¸€åˆ©ç‡ï¼Œåƒ…å¡«ç¬¬ä¸€æ®µå³å¯
    </small>

    <div class="section-header">ğŸ’µ å…¶ä»–è²»ç”¨</div>

    <div class="input-group">
        <label for="brokerFeeRate">ğŸ¢ æˆ¿ä»²æœå‹™è²» (è²·æ–¹ %)</label>
        <input type="number" id="brokerFeeRate" value="1" min="0" max="2" step="0.1">
        <small class="hint">é€šå¸¸ä¸Šé™ç‚ºæˆäº¤åƒ¹çš„ 2% (è²·æ–¹)</small>
    </div>

    <div class="input-group">
        <label for="estimatedClosingCosts">ğŸ“„ ä¼°è¨ˆé›œé …ç¨…è²» (è¬å…ƒ)</label>
        <input type="number" id="estimatedClosingCosts" value="5" min="0" step="1">
        <small class="hint">åŒ…å«ä»£æ›¸è²»ã€å¥‘ç¨…ã€å°èŠ±ç¨…ç­‰ä¼°è¨ˆå€¼</small>
    </div>

    <button class="btn-primary" id="startCalcBtn">ğŸš€ é–‹å§‹è¨ˆç®—ç¸½è²»ç”¨</button>
    <button class="btn-secondary" onclick="location.reload()">ğŸ”„ é‡æ–°è¨ˆç®—</button>

    <div id="resultArea" class="result-area">
        <h3>ğŸ“Š è©¦ç®—çµæœç¸½è¦½</h3>
        <div class="result-item highlight">
            <span class="result-label">ğŸ’¸ è²¸æ¬¾ç¸½é‡‘é¡</span>
            <span id="loanAmount" class="result-value"></span>
        </div>
        <div class="result-item">
            <span class="result-label">â³ ç¸½ç¹³æ¬¾æœˆæ•¸</span>
            <span id="totalMonths" class="result-value"></span>
        </div>
        <div id="stagePayments"></div>
        <div class="result-item highlight">
            <span class="result-label">ğŸ“ˆ å¹³å‡æ¯æœˆé‚„æ¬¾</span>
            <span id="avgPayment" class="result-value"></span>
        </div>
        <div class="result-item">
            <span class="result-label">ğŸ’” ç¸½è¨ˆæ”¯ä»˜åˆ©æ¯</span>
            <span id="totalInterest" class="result-value negative"></span>
        </div>
        <div class="result-item highlight">
            <span class="result-label">ğŸ’° ç¸½é‚„æ¬¾é‡‘é¡ (æœ¬é‡‘+åˆ©æ¯)</span>
            <span id="totalRepayment" class="result-value"></span>
        </div>
        <div class="result-item">
            <span class="result-label">ğŸ¢ æˆ¿ä»²æœå‹™è²»</span>
            <span id="brokerFeeAmount" class="result-value"></span>
        </div>
        <div class="result-item">
            <span class="result-label">ğŸ“„ ç¸½é›œé …æˆæœ¬ï¼ˆå«æˆ¿ä»²è²»ï¼‰</span>
            <span id="totalTransactionCosts" class="result-value"></span>
        </div>
        <div class="result-item highlight">
            <span class="result-label">ğŸ’µ è³¼å±‹ç¸½è‡ªå‚™ç¾é‡‘</span>
            <span id="totalUpfrontCash" class="result-value"></span>
        </div>
        <div class="result-item highlight">
            <span class="result-label">ğŸ  æˆ¿å±‹æœ€çµ‚ç¸½æ”¯å‡ºæˆæœ¬</span>
            <span id="totalCost" class="result-value"></span>
        </div>
        <div class="info-box" id="detailInfo"></div>
    </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <h4>âš ï¸ è¼¸å…¥éŒ¯èª¤</h4>
        <div id="alertModalBody"></div>
        <div class="modal-actions">
            <button class="btn-ok" id="alertOkBtn">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<script>
const TEN_THOUSAND = 10000;

/* -------------------------
   åƒä½ç¬¦è™•ç†å·¥å…·
   ------------------------- */
// å¾å«åƒåˆ†ç¬¦çš„å­—ä¸²è§£ææ•¸å­—ï¼ˆå…è¨±å°æ•¸ï¼‰ï¼Œå›å‚³ Numberï¼ˆè‹¥ç„¡æ•ˆå› NaNï¼‰
function parseNumberFromInputStr(s) {
    if (typeof s !== 'string') return NaN;
    const clean = s.replace(/,/g, '').trim();
    if (clean === '') return NaN;
    return Number(clean);
}

// æŠŠå­—ä¸²æˆ–æ•¸å­—æ ¼å¼åŒ–ç‚ºåƒåˆ†ä½é¡¯ç¤ºï¼ˆä¿ç•™å°æ•¸éƒ¨åˆ†ï¼‰
function formatWithThousands(valStrOrNum) {
    if (valStrOrNum === null || valStrOrNum === undefined) return '';
    const s = String(valStrOrNum).trim();
    if (s === '') return '';
    const parts = s.replace(/,/g,'').split('.');
    let intPart = parts[0].replace(/^0+(?=\d)/,''); // å»å‰å°é›¶
    if (intPart === '') intPart = '0';
    const decPart = parts.length > 1 ? parts[1] : null;
    intPart = Number(intPart).toLocaleString('zh-TW');
    return decPart !== null ? `${intPart}.${decPart}` : intPart;
}

// æ¸…ç†è¼¸å…¥ï¼ˆå…è¨±æ•¸å­—èˆ‡ä¸€å€‹å°æ•¸é»ï¼‰
function sanitizeInputForDisplay(raw) {
    const cleaned = raw.replace(/[^\d.]/g, '');
    const firstDotIndex = cleaned.indexOf('.');
    if (firstDotIndex === -1) return cleaned;
    const before = cleaned.slice(0, firstDotIndex + 1);
    const after = cleaned.slice(firstDotIndex + 1).replace(/\./g, '');
    return before + after;
}

// å³æ™‚æ ¼å¼åŒ–è¼¸å…¥ï¼ˆinput äº‹ä»¶ï¼‰
function handleFormattedInputInput(e) {
    const node = e.target;
    const raw = node.value;
    const caretFromEnd = node.value.length - node.selectionStart;
    const sanitized = sanitizeInputForDisplay(raw);
    const formatted = formatWithThousands(sanitized);
    node.value = formatted;
    try {
        const pos = Math.max(0, node.value.length - caretFromEnd);
        node.setSelectionRange(pos, pos);
    } catch (err) {}
}

// blur æ™‚åš´æ ¼è™•ç†ï¼šè‹¥éæ•¸å­—å‰‡æ¸…ç©ºï¼Œå¦å‰‡æ ¼å¼åŒ–ï¼ˆä¿ç•™å°æ•¸ï¼‰
function handleFormattedInputBlur(e) {
    const node = e.target;
    const raw = node.value;
    const parsed = parseNumberFromInputStr(raw);
    if (!isFinite(parsed)) {
        node.value = '';
        return;
    }
    node.value = formatWithThousands(String(parsed));
}

/* -------------------------
   åŸæœ‰è¨ˆç®—/é©—è­‰å‡½æ•¸ï¼ˆç¶­æŒåŸé‚è¼¯ï¼Œä½†è®€å– purchasePrice/downPayment æ™‚è§£æåƒåˆ†ç¬¦ï¼‰
   ------------------------- */

function formatTenThousands(amountInYuan, precision = 2) {
    const v = Number(amountInYuan) / TEN_THOUSAND;
    if (!isFinite(v)) return '0 è¬å…ƒ';
    return v.toLocaleString('zh-TW', { 
        minimumFractionDigits: precision, 
        maximumFractionDigits: precision 
    }) + ' è¬å…ƒ';
}

function monthlyPaymentFor(P, annualRate, months) {
    P = Number(P); 
    months = Number(months);
    if (!isFinite(P) || !isFinite(months) || months <= 0 || P <= 0) return 0;
    const r = annualRate / 12 / 100;
    if (r === 0) return P / months;
    const f = Math.pow(1 + r, months);
    return P * (r * f) / (f - 1);
}

function remainingBalanceAfterPayments(P, annualRate, payment, k) {
    P = Number(P); 
    k = Number(k);
    if (!isFinite(P) || !isFinite(k) || k <= 0) return P;
    const r = annualRate / 12 / 100;
    if (r === 0) return Math.max(0, P - payment * k);
    const f = Math.pow(1 + r, k);
    return Math.max(0, P * f - payment * ((f - 1) / r));
}

// DOM å…ƒç´ 
const el = {
    purchasePrice: document.getElementById('purchasePrice'),
    downPayment: document.getElementById('downPayment'),
    loanTerm: document.getElementById('loanTerm'),
    gracePeriod: document.getElementById('gracePeriod'),
    stage1Start: document.getElementById('stage1Start'),
    stage1End: document.getElementById('stage1End'),
    stage1Rate: document.getElementById('stage1Rate'),
    stage2Start: document.getElementById('stage2Start'),
    stage2End: document.getElementById('stage2End'),
    stage2Rate: document.getElementById('stage2Rate'),
    stage3Start: document.getElementById('stage3Start'),
    stage3End: document.getElementById('stage3End'),
    stage3Rate: document.getElementById('stage3Rate'),
    rateRow2: document.getElementById('rateRow2'),
    rateRow3: document.getElementById('rateRow3'),
    brokerFeeRate: document.getElementById('brokerFeeRate'),
    estimatedClosingCosts: document.getElementById('estimatedClosingCosts'),
    resultArea: document.getElementById('resultArea'),
    loanAmount: document.getElementById('loanAmount'),
    totalMonths: document.getElementById('totalMonths'),
    stagePayments: document.getElementById('stagePayments'),
    avgPayment: document.getElementById('avgPayment'),
    brokerFeeAmount: document.getElementById('brokerFeeAmount'),
    totalTransactionCosts: document.getElementById('totalTransactionCosts'),
    totalUpfrontCash: document.getElementById('totalUpfrontCash'),
    totalInterest: document.getElementById('totalInterest'),
    totalRepayment: document.getElementById('totalRepayment'),
    totalCost: document.getElementById('totalCost'),
    detailInfo: document.getElementById('detailInfo'),
    startCalcBtn: document.getElementById('startCalcBtn'),
    alertModal: document.getElementById('alertModal'),
    alertModalBody: document.getElementById('alertModalBody'),
    alertOkBtn: document.getElementById('alertOkBtn')
};

// Modal å‡½æ•¸
function showAlertModal(messages) {
    el.alertModalBody.innerHTML = '<ul style="margin-left:16px;text-align:left;">' + 
        messages.map(m => `<li>${m}</li>`).join('') + '</ul>';
    el.alertModal.classList.add('show');
    el.alertModal.setAttribute('aria-hidden', 'false');
    setTimeout(() => el.alertOkBtn.focus(), 10);
}

function hideAlertModal() {
    el.alertModal.classList.remove('show');
    el.alertModal.setAttribute('aria-hidden', 'true');
    setTimeout(() => el.startCalcBtn.focus(), 10);
}

// å°å·¥å…·ï¼šå®‰å…¨ parseInt
function toIntSafe(v) {
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : null;
}

// é©—è­‰åˆ†æ®µåˆ©ç‡è¼¸å…¥
function validateStageInputs(totalMonths, graceMonths) {
    const errors = [];
    const stages = [];
    
    for (let i = 1; i <= 3; i++) {
        const start = el[`stage${i}Start`].value;
        const end = el[`stage${i}End`].value;
        const rate = el[`stage${i}Rate`].value;
        
        const filled = [start, end, rate].filter(v => v !== '').length;
        
        if (filled > 0 && filled < 3) {
            errors.push(`ç¬¬${i}æ®µåˆ©ç‡çš„æ¬„ä½æœªå®Œæ•´å¡«å¯«ï¼ˆèµ·å§‹æœˆã€çµæŸæœˆã€åˆ©ç‡å¿…é ˆå…¨éƒ¨å¡«å¯«ï¼‰`);
            continue;
        }
        
        if (filled === 3) {
            const s = parseInt(start, 10);
            const e = parseInt(end, 10);
            const r = parseFloat(rate);
            
            if (!Number.isInteger(s) || s < 1) {
                errors.push(`ç¬¬${i}æ®µåˆ©ç‡çš„èµ·å§‹æœˆå¿…é ˆç‚ºæ­£æ•´æ•¸`);
                continue;
            }
            if (!Number.isInteger(e) || e < 1) {
                errors.push(`ç¬¬${i}æ®µåˆ©ç‡çš„çµæŸæœˆå¿…é ˆç‚ºæ­£æ•´æ•¸`);
                continue;
            }
            if (!isFinite(r) || r < 0) {
                errors.push(`ç¬¬${i}æ®µåˆ©ç‡å¿…é ˆç‚ºéè² æ•¸`);
                continue;
            }
            
            if (e < s) {
                errors.push(`ç¬¬${i}æ®µåˆ©ç‡çš„çµæŸæœˆ (${e}) ä¸èƒ½å°æ–¼èµ·å§‹æœˆ (${s})`);
                continue;
            }
            
            if (e > totalMonths) {
                errors.push(`ç¬¬${i}æ®µåˆ©ç‡çš„çµæŸæœˆ (${e}) è¶…éè²¸æ¬¾ç¸½æœŸæ•¸ (${totalMonths})`);
                continue;
            }
            
            stages.push({ stage: i, start: s, end: e, rate: r });
        }
    }
    
    if (stages.length === 0 && errors.length === 0) {
        errors.push('è‡³å°‘éœ€è¦å¡«å¯«ä¸€æ®µåˆ©ç‡');
        return { valid: false, errors, stages: [] };
    }
    
    if (errors.length > 0) {
        return { valid: false, errors, stages: [] };
    }
    
    stages.sort((a, b) => a.start - b.start);
    
    const repaymentStartMonth = graceMonths + 1;
    const expectedStart = graceMonths > 0 ? repaymentStartMonth : 1;
    
    if (stages[0].start !== expectedStart) {
        if (graceMonths > 0) {
            errors.push(`æœ‰å¯¬é™æœŸ ${graceMonths} å€‹æœˆï¼Œç¬¬ä¸€æ®µåˆ©ç‡æ‡‰å¾ç¬¬ ${repaymentStartMonth} æœˆé–‹å§‹ï¼ˆç›®å‰å¾ç¬¬ ${stages[0].start} æœˆé–‹å§‹ï¼‰`);
        } else {
            errors.push(`ç¬¬ä¸€æ®µåˆ©ç‡å¿…é ˆå¾ç¬¬ 1 æœˆé–‹å§‹ï¼ˆç›®å‰å¾ç¬¬ ${stages[0].start} æœˆé–‹å§‹ï¼‰`);
        }
    }
    
    for (let i = 0; i < stages.length - 1; i++) {
        const current = stages[i];
        const next = stages[i + 1];
        
        if (next.start !== current.end + 1) {
            if (next.start <= current.end) {
                errors.push(`ç¬¬${current.stage}æ®µ (${current.start}-${current.end}) èˆ‡ç¬¬${next.stage}æ®µ (${next.start}-${next.end}) æœ‰é‡ç–Š`);
            } else {
                errors.push(`ç¬¬${current.stage}æ®µçµæŸæ–¼ç¬¬ ${current.end} æœˆï¼Œä½†ç¬¬${next.stage}æ®µå¾ç¬¬ ${next.start} æœˆé–‹å§‹ï¼Œä¸­é–“æœ‰é–“éš™`);
            }
        }
    }
    
    const lastStage = stages[stages.length - 1];
    if (lastStage.end < totalMonths) {
        errors.push(`æœ€å¾Œä¸€æ®µåˆ©ç‡çµæŸæ–¼ç¬¬ ${lastStage.end} æœˆï¼Œä½†è²¸æ¬¾ç¸½æœŸæ•¸ç‚º ${totalMonths} æœˆï¼Œæœªå®Œå…¨è¦†è“‹`);
    }
    
    return { valid: errors.length === 0, errors, stages };
}

// ä¸»è¨ˆç®—å‡½æ•¸ï¼ˆè§£æåƒåˆ†ç¬¦ï¼‰
function calculateMortgage() {
    const P_tm_raw = el.purchasePrice.value;
    const D_tm_raw = el.downPayment.value;
    const P_tm_num = parseNumberFromInputStr(P_tm_raw); // è¬å…ƒå–®ä½
    const D_tm_num = parseNumberFromInputStr(D_tm_raw); // è¬å…ƒå–®ä½

    const P_tm = isFinite(P_tm_num) ? P_tm_num : 0;
    const D_tm = isFinite(D_tm_num) ? D_tm_num : 0;

    const T = Math.max(0, parseInt(el.loanTerm.value, 10) || 0);
    const graceYears = Math.max(0, parseInt(el.gracePeriod.value, 10) || 0);

    if (P_tm <= 0 || T <= 0) {
        showAlertModal(["æˆ¿å±‹ç¸½åƒ¹èˆ‡è²¸æ¬¾å¹´æœŸå¿…é ˆå¤§æ–¼é›¶"]);
        return;
    }

    const P_Yuan = P_tm * TEN_THOUSAND;
    const D_Yuan = D_tm * TEN_THOUSAND;
    const L = P_Yuan - D_Yuan;
    const totalMonths = T * 12;
    const graceMonths = Math.min(totalMonths, graceYears * 12);
    const monthsAfterGrace = Math.max(0, totalMonths - graceMonths);

    const BrokerRate = Number(el.brokerFeeRate.value) / 100 || 0;
    const C_closing_Yuan = (Number(el.estimatedClosingCosts.value) || 0) * TEN_THOUSAND;

    if (L <= 0) {
        renderFullPaymentCase(P_Yuan, BrokerRate, C_closing_Yuan);
        return;
    }

    const validation = validateStageInputs(totalMonths, graceMonths);
    if (!validation.valid) {
        showAlertModal(validation.errors);
        return;
    }

    const stages = validation.stages;
    
    // è¨ˆç®—å¯¬é™æœŸåˆ©æ¯
    let totalInterest = 0;
    let stageHTML = '';
    
    if (graceMonths > 0) {
        const rGrace = stages[0].rate;
        const monthlyInterestOnly = L * (rGrace / 12 / 100);
        const graceInterestTotal = monthlyInterestOnly * graceMonths;
        totalInterest += graceInterestTotal;
        stageHTML += `<div class="result-item"><span class="result-label">ğŸ•Šï¸ å¯¬é™æœŸï¼ˆç¬¬ 1-${graceMonths} æœŸï¼‰â€” æ¯æœˆåˆ©æ¯</span><span class="result-value">${formatTenThousands(monthlyInterestOnly,4)}</span></div>`;
    }

    // è¨ˆç®—å„éšæ®µé‚„æ¬¾
    let remainingPrincipal = L;
    let monthsRemainingForCalc = monthsAfterGrace;

    function computeStage(stageMonths, annualRate) {
        if (stageMonths <= 0) return null;
        if (!isFinite(annualRate)) annualRate = 0;
        const payment = monthlyPaymentFor(remainingPrincipal, annualRate, monthsRemainingForCalc);
        const balanceAfter = remainingBalanceAfterPayments(remainingPrincipal, annualRate, payment, stageMonths);
        const interestPaid = payment * stageMonths - (remainingPrincipal - balanceAfter);
        return { payment, balanceAfter, interestPaid };
    }

    for (let stageInfo of stages) {
        const stageMonths = stageInfo.end - stageInfo.start + 1;
        const res = computeStage(stageMonths, stageInfo.rate);
        
        if (res) {
            totalInterest += res.interestPaid;
            stageHTML += `<div class="result-item"><span class="result-label">ğŸ“ ç¬¬${stageInfo.stage}æ®µ (ç¬¬ ${stageInfo.start}-${stageInfo.end} æœŸ, ${stageInfo.rate}%)</span><span class="result-value">${formatTenThousands(res.payment,4)}</span></div>`;
            remainingPrincipal = res.balanceAfter;
            monthsRemainingForCalc -= stageMonths;
        }
    }

    // è¨ˆç®—ç¸½æˆæœ¬
    const brokerFeeAmount = P_Yuan * BrokerRate;
    const totalTransactionCosts = brokerFeeAmount + C_closing_Yuan;
    const totalUpfrontCash = D_Yuan + totalTransactionCosts;
    const totalRepayment = L + totalInterest;
    const avgPayment = totalRepayment / totalMonths;
    const totalCost = P_Yuan + totalInterest + totalTransactionCosts;

    // é¡¯ç¤ºçµæœ
    el.loanAmount.textContent = formatTenThousands(L);
    el.totalMonths.textContent = `${totalMonths} å€‹æœˆ${graceMonths > 0 ? `ï¼ˆå«å¯¬é™æœŸ ${graceMonths} æœŸï¼‰` : ''}`;
    el.stagePayments.innerHTML = stageHTML || '<div class="info-box">â€» ç„¡åˆ†æ®µæˆ–åˆ†æ®µæœˆä»˜ç‚º 0</div>';
    el.avgPayment.textContent = formatTenThousands(avgPayment,2);
    el.totalInterest.textContent = formatTenThousands(totalInterest);
    el.brokerFeeAmount.textContent = formatTenThousands(brokerFeeAmount);
    el.totalTransactionCosts.textContent = formatTenThousands(totalTransactionCosts);
    el.totalUpfrontCash.textContent = formatTenThousands(totalUpfrontCash);
    el.totalRepayment.textContent = formatTenThousands(totalRepayment);
    el.totalCost.textContent = formatTenThousands(totalCost);

    const interestRatio = L > 0 ? ((totalInterest / L) * 100).toFixed(2) : '0.00';
    let detailHTML = '<strong>ğŸ’¡ è©³ç´°èªªæ˜ï¼š</strong><br>';
    detailHTML += `â€¢ è²¸æ¬¾æœ¬é‡‘ï¼š${formatTenThousands(L)}<br>`;
    detailHTML += `â€¢ ç¸½ç¹³æ¬¾æœŸæ•¸ï¼š${totalMonths} å€‹æœˆ` ;
    if (graceMonths > 0) {
        detailHTML += `ï¼ˆå¯¬é™æœŸ ${graceMonths} æœŸï¼Œæ­£å¼æ”¤é‚„æœŸ ${monthsAfterGrace} æœŸï¼‰`;
    }
    detailHTML += `<br>`;
    detailHTML += `â€¢ ç¸½åˆ©æ¯æ”¯å‡ºï¼š${formatTenThousands(totalInterest)}<br>`;
    detailHTML += `â€¢ åˆ©æ¯ä½”è²¸æ¬¾æ¯”ä¾‹ï¼š${interestRatio}%<br>`;
    detailHTML += `â€¢ æˆ¿ä»²è²»ï¼š${formatTenThousands(brokerFeeAmount)}<br>`;
    detailHTML += `â€¢ ç¸½é›œé …æˆæœ¬ï¼ˆå«æˆ¿ä»²è²»ï¼‰ï¼š${formatTenThousands(totalTransactionCosts)}<br>`;
    if (graceMonths > 0) {
        detailHTML += `<br><strong>âš ï¸ å¯¬é™æœŸèªªæ˜ï¼š</strong><br>`;
        detailHTML += `å¯¬é™æœŸå…§åªç¹³åˆ©æ¯ï¼Œåˆ©ç‡æ¡ç”¨ç¬¬ä¸€éšæ®µåˆ©ç‡ï¼ˆ${stages[0].rate}%ï¼‰ï¼Œæœ¬é‡‘ä¸æ”¤é‚„ã€‚`;
    }
    el.detailInfo.innerHTML = detailHTML;

    el.resultArea.style.display = 'block';
}

// å…¨é¡ä»˜æ¸…æƒ…æ³
function renderFullPaymentCase(P_Yuan, BrokerRate, C_closing_Yuan) {
    const brokerFeeAmount = P_Yuan * BrokerRate;
    const totalTransactionCosts = brokerFeeAmount + C_closing_Yuan;
    const totalUpfrontCash = P_Yuan + totalTransactionCosts;
    
    el.loanAmount.textContent = formatTenThousands(0);
    el.totalMonths.textContent = `0 å€‹æœˆ`;
    el.stagePayments.innerHTML = `<div class="info-box">âœ… å…¨é¡ä»˜æ¸…ï¼Œç„¡éœ€è²¸æ¬¾</div>`;
    el.avgPayment.textContent = formatTenThousands(0,2);
    el.brokerFeeAmount.textContent = formatTenThousands(brokerFeeAmount);
    el.totalTransactionCosts.textContent = formatTenThousands(totalTransactionCosts);
    el.totalUpfrontCash.textContent = formatTenThousands(totalUpfrontCash);
    el.totalInterest.textContent = formatTenThousands(0);
    el.totalRepayment.textContent = formatTenThousands(0);
    el.totalCost.textContent = formatTenThousands(totalUpfrontCash);
    el.detailInfo.innerHTML = '<strong>ğŸ’¡ èªªæ˜ï¼š</strong><br>æ‚¨é¸æ“‡å…¨é¡ä»˜æ¸…ï¼Œç„¡éœ€æ”¯ä»˜ä»»ä½•è²¸æ¬¾åˆ©æ¯ã€‚<br>â€¢ ç¸½é›œé …æˆæœ¬ï¼ˆå«æˆ¿ä»²è²»ï¼‰ï¼š' + formatTenThousands(totalTransactionCosts) + 'ã€‚';
    el.resultArea.style.display = 'block';
}

/* ---------------------------
   ç¦ç”¨/åç™½ æ§åˆ¶å‡½å¼ï¼ˆä¸è®Šï¼‰
   --------------------------- */
function setStage2and3Disabled(disabled) {
    const ids2 = ['stage2Start','stage2End','stage2Rate'];
    const ids3 = ['stage3Start','stage3End','stage3Rate'];
    if (disabled) {
        ids2.forEach(id => {
            document.getElementById(id).value = '';
            document.getElementById(id).disabled = true;
        });
        ids3.forEach(id => {
            document.getElementById(id).value = '';
            document.getElementById(id).disabled = true;
        });
        document.getElementById('rateRow2').classList.add('disabled-stage');
        document.getElementById('rateRow3').classList.add('disabled-stage');
    } else {
        ids2.forEach(id => {
            document.getElementById(id).disabled = false;
        });
        ids3.forEach(id => {
            document.getElementById(id).disabled = false;
        });
        document.getElementById('rateRow2').classList.remove('disabled-stage');
        document.getElementById('rateRow3').classList.remove('disabled-stage');
    }
}

function setStage3Disabled(disabled) {
    const ids3 = ['stage3Start','stage3End','stage3Rate'];
    if (disabled) {
        ids3.forEach(id => {
            document.getElementById(id).value = '';
            document.getElementById(id).disabled = true;
        });
        document.getElementById('rateRow3').classList.add('disabled-stage');
    } else {
        ids3.forEach(id => {
            document.getElementById(id).disabled = false;
        });
        document.getElementById('rateRow3').classList.remove('disabled-stage');
    }
}

/* ---------------------------
   è‡ªå‹•åŒæ­¥èµ·å§‹æœˆä»½ï¼ˆå«æ‰‹å‹•è¦†å¯«ä¿è­·ï¼‰
   --------------------------- */

// è¿½è¹¤ä½¿ç”¨è€…æ˜¯å¦æ‰‹å‹•ç·¨è¼¯éæŸå€‹ start æ¬„ä½ï¼ˆè‹¥ trueï¼Œå‰‡ä¸è¦è‡ªå‹•è¦†å¯«ï¼‰
const manualEdit = {
    stage2Start: false,
    stage3Start: false
};

// è¨»å†Šä½¿ç”¨è€…æ‰‹å‹•ç·¨è¼¯å•Ÿç”¨ flag
['stage2Start','stage3Start'].forEach(id => {
    const node = document.getElementById(id);
    node.addEventListener('input', () => {
        manualEdit[id] = node.value !== '';
    });
});

// syncStageStartsï¼šæ›´å¼·å¥çš„åŒæ­¥é‚è¼¯
function syncStageStarts() {
    const totalMonths = (parseInt(document.getElementById('loanTerm').value, 10) || 0) * 12;
    const graceYears = parseInt(document.getElementById('gracePeriod').value, 10) || 0;
    const graceMonths = Math.min(totalMonths, graceYears * 12);
    const expectedFirstStart = graceMonths > 0 ? (graceMonths + 1) : 1;

    if (graceMonths > 0) {
        document.getElementById('stage1Start').value = expectedFirstStart;
    } else {
        if (!document.getElementById('stage1Start').value) {
            document.getElementById('stage1Start').value = 1;
        }
    }

    const s1end = toIntSafe(document.getElementById('stage1End').value);
    const s2end = toIntSafe(document.getElementById('stage2End').value);

    if (s1end !== null && !document.getElementById('stage2Start').disabled) {
        const autoVal = s1end + 1;
        if (!manualEdit.stage2Start) {
            document.getElementById('stage2Start').value = Math.min(autoVal, totalMonths);
        }
    }

    if (s2end !== null && !document.getElementById('stage3Start').disabled) {
        const autoVal2 = s2end + 1;
        if (!manualEdit.stage3Start) {
            document.getElementById('stage3Start').value = Math.min(autoVal2, totalMonths);
        }
    }

    ['stage1Start','stage2Start','stage3Start'].forEach(id => {
        const node = document.getElementById(id);
        const v = toIntSafe(node.value);
        if (v !== null && v > totalMonths) {
            node.value = totalMonths;
        }
    });

    if (s1end !== null && s1end >= totalMonths) {
        setStage2and3Disabled(true);
    } else {
        setStage2and3Disabled(false);
        if (s2end !== null && s2end >= totalMonths) {
            setStage3Disabled(true);
        } else {
            setStage3Disabled(false);
        }
    }
}

/* ---------------------------
   äº‹ä»¶ç¶å®š
   --------------------------- */

// å…©å€‹æ¬„ä½ï¼ˆpurchasePrice / downPaymentï¼‰åŠ ä¸Šå³æ™‚åƒä½ç¬¦è™•ç†
['purchasePrice','downPayment'].forEach(id => {
    const node = document.getElementById(id);
    if (!node) return;
    node.addEventListener('input', handleFormattedInputInput);
    node.addEventListener('blur', handleFormattedInputBlur);
    node.addEventListener('paste', () => {
        setTimeout(() => {
            node.value = sanitizeInputForDisplay(node.value);
            node.value = formatWithThousands(node.value);
        }, 0);
    });
});

// ç•¶ä½¿ç”¨è€…æ”¹è®Š stage1End æˆ– stage2End æˆ– loanTerm/gracePeriod æ™‚ï¼Œç«‹åˆ»åŒæ­¥
['stage1End','stage2End','gracePeriod','loanTerm'].forEach(id => {
    const node = document.getElementById(id);
    if (node) {
        node.addEventListener('change', syncStageStarts);
        node.addEventListener('blur', syncStageStarts);
        node.addEventListener('input', syncStageStarts);
    }
});

// å¦‚æœä½¿ç”¨è€…æ¸…ç©ºäº† stage2Start/stage3Startï¼ˆæ‰‹å‹•åˆªæ‰ï¼‰ï¼Œå°‡è¦–ç‚ºå–æ¶ˆæ‰‹å‹•è¦†å¯«ï¼Œå…è¨±å¾ŒçºŒè‡ªå‹•å¡«å›
['stage2Start','stage3Start'].forEach(id => {
    const node = document.getElementById(id);
    node.addEventListener('blur', () => {
        if (node.value === '') {
            manualEdit[id] = false;
            syncStageStarts();
        }
    });
});

// å…¶å®ƒäº‹ä»¶ç›£è½
document.getElementById('startCalcBtn').addEventListener('click', calculateMortgage);
document.getElementById('alertOkBtn').addEventListener('click', hideAlertModal);

// Enter éµè§¸ç™¼è¨ˆç®—ï¼ˆåŒ…å« text inputsï¼‰
document.querySelectorAll('input').forEach(input => {
    input.addEventListener('keypress', e => {
        if (e.key === 'Enter') calculateMortgage();
    });
});

// åˆæ¬¡è¼‰å…¥åŒæ­¥èˆ‡æ ¼å¼åŒ–
document.addEventListener('DOMContentLoaded', () => {
    // æ ¼å¼åŒ–é è¨­é¡¯ç¤ºå€¼ï¼ˆæœ‰åƒä½ç¬¦ï¼‰
    const pp = document.getElementById('purchasePrice');
    const dp = document.getElementById('downPayment');
    if (pp) pp.value = formatWithThousands(pp.value || '');
    if (dp) dp.value = formatWithThousands(dp.value || '');
    // ä¿æŒåˆ†æ®µé‚è¼¯åŸæœ¬è¡Œç‚º
    document.getElementById('stage1Start').value = '';
    document.getElementById('stage2Start').value = '';
    document.getElementById('stage3Start').value = '';
    manualEdit.stage2Start = false;
    manualEdit.stage3Start = false;
    syncStageStarts();
});
</script>
</body>
</html>
